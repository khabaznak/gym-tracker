{{> header title="Dashboard" subtitle="Check your plan, track the week, and review recent sessions at a glance."}}

<main class="mx-auto mt-10 flex w-full max-w-5xl flex-col gap-8 px-6 pb-16">
  <section class="rounded-xl bg-white p-6 shadow-lg ring-1 ring-graphite/10 dark:bg-graphite dark:text-fog dark:ring-graphite/40">
    <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
      <div class="space-y-2">
        <h2 class="text-lg font-semibold text-ink dark:text-white">Current plan</h2>
        {{#if planError}}
          <p class="rounded-lg border border-orange/40 bg-orange/10 px-3 py-2 text-sm text-orange dark:border-orange/40 dark:bg-orange/10 dark:text-orange">{{planError}}</p>
        {{else if supabaseReady}}
          {{#if activePlan}}
            <div class="space-y-1 text-sm text-graphite/80 dark:text-fog/80">
              <p><span class="font-semibold text-ink dark:text-white">{{activePlan.name}}</span> · {{capitalize activePlan.period}} · Week {{planWeekIndex}}</p>
              {{#if activePlan.label}}
                <p class="text-xs uppercase tracking-wide text-graphite/60 dark:text-fog/60">Label: {{activePlan.label}}</p>
              {{/if}}
              <p class="text-xs uppercase tracking-wide text-graphite/60 dark:text-fog/60">Status: <span class="font-semibold {{#if (eq activePlan.status 'active')}}text-teal dark:text-orange{{else}}text-graphite/70 dark:text-fog/70{{/if}}">{{capitalize activePlan.status}}</span></p>
            </div>
            <dl class="mt-4 grid grid-cols-3 gap-3 text-xs text-graphite/70 dark:text-fog/70">
              <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
                <dt class="uppercase tracking-wide">Minutes logged</dt>
                <dd class="mt-1 text-base font-semibold text-ink dark:text-white">{{activitySummary.totalMinutes}}</dd>
              </div>
              <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
                <dt class="uppercase tracking-wide">Avg min / active day</dt>
                <dd class="mt-1 text-base font-semibold text-ink dark:text-white">{{activitySummary.avgMinutesPerActiveDay}}</dd>
              </div>
              <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
                <dt class="uppercase tracking-wide">Best streak</dt>
                <dd class="mt-1 text-base font-semibold text-ink dark:text-white">{{activitySummary.bestStreak}} day{{#unless (eq activitySummary.bestStreak 1)}}s{{/unless}}</dd>
              </div>
            </dl>
            <div class="mt-4 space-y-2">
              <div class="flex items-center justify-between">
                <p class="text-xs uppercase tracking-wide text-graphite/60 dark:text-fog/60">Recent activity</p>
                <span class="text-xs text-graphite/50 dark:text-fog/60">More color = more minutes logged</span>
              </div>
              {{#if activityHeatmap.weeks.length}}
                <div class="overflow-x-auto">
                  <table class="heatmap-table text-[11px] text-graphite/70 dark:text-fog/70">
                    <thead>
                      <tr>
                        <th class="heatmap-corner"></th>
                        {{#each activityHeatmap.weeks}}
                          <th class="heatmap-week">{{label}}</th>
                        {{/each}}
                      </tr>
                    </thead>
                    <tbody>
                      {{#each activityHeatmap.rows}}
                        <tr>
                          <th class="heatmap-day">{{label}}</th>
                          {{#each cells}}
                            <td class="heatmap-cell">
                              <span
                                class="heatmap-dot"
                                data-intensity="{{intensity}}"
                                data-tooltip="{{formatDate isoDate}} · {{minutes}} min"
                              ></span>
                            </td>
                          {{/each}}
                        </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>
                {{#if activityHeatmap.legend.length}}
                  <ul class="heatmap-legend">
                    {{#each activityHeatmap.legend}}
                      <li>
                        <span class="heatmap-dot" data-intensity="{{intensity}}"></span>
                        <span>{{label}}</span>
                      </li>
                    {{/each}}
                  </ul>
                {{/if}}
              {{else}}
                <p class="rounded-lg border border-graphite/10 bg-fog/60 px-3 py-2 text-xs text-graphite/60 dark:border-fog/20 dark:bg-graphite/60 dark:text-fog/70">No recent session data yet. Complete a session to see trends here.</p>
              {{/if}}
            </div>
          {{else}}
            <p class="rounded-lg border border-graphite/10 bg-fog/60 px-3 py-2 text-sm text-graphite/70 dark:border-fog/20 dark:bg-graphite/60 dark:text-fog/70">No active plan yet. Activate one in Manage Plans to populate your dashboard.</p>
          {{/if}}
        {{else}}
          <p class="rounded-lg border border-graphite/10 bg-fog/60 px-3 py-2 text-sm text-graphite/70 dark:border-fog/20 dark:bg-graphite/60 dark:text-fog/70">Connect Supabase to load plan and session data.</p>
        {{/if}}
      </div>
      <dl class="grid w-full max-w-xl grid-cols-2 gap-4 text-sm text-graphite/80 dark:text-fog/80 sm:grid-cols-4">
        <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
          <dt class="text-xs font-semibold uppercase tracking-wide text-graphite/60 dark:text-fog/60">Sessions this week</dt>
          <dd class="text-lg font-semibold text-ink dark:text-white">{{weeklySummary.totalSessions}}</dd>
        </div>
        <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
          <dt class="text-xs font-semibold uppercase tracking-wide text-graphite/60 dark:text-fog/60">Completed</dt>
          <dd class="text-lg font-semibold text-ink dark:text-white">{{weeklySummary.completedSessions}}</dd>
        </div>
        <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
      <dt class="text-xs font-semibold uppercase tracking-wide text-graphite/60 dark:text-fog/60">In progress</dt>
      <dd class="text-lg font-semibold text-ink dark:text-white">{{weeklySummary.inProgressSessions}}</dd>
    </div>
    <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
      <dt class="text-xs font-semibold uppercase tracking-wide text-graphite/60 dark:text-fog/60">Logged minutes</dt>
      <dd class="text-lg font-semibold text-ink dark:text-white">{{weeklySummary.totalDurationMinutes}}</dd>
    </div>
    <div class="rounded-lg border border-graphite/10 bg-fog/50 px-3 py-2 shadow-sm dark:border-fog/20 dark:bg-graphite/70">
      <dt class="text-xs font-semibold uppercase tracking-wide text-graphite/60 dark:text-fog/60">Avg min / active day</dt>
      <dd class="text-lg font-semibold text-ink dark:text-white">{{weeklySummary.avgMinutesPerActiveDay}}</dd>
    </div>
  </dl>
    </div>
  </section>

  {{> dashboard/weekly-activity
      supabaseReady=supabaseReady
      planWeekIndex=planWeekIndex
      weekRangeLabel=weekRangeLabel
      weeklyDays=weeklyDays
      weeklySummary=weeklySummary
      weekOffset=weekOffset
  }}

  <section class="rounded-xl bg-white p-6 shadow-lg ring-1 ring-graphite/10 dark:bg-graphite dark:text-fog dark:ring-graphite/40">
    <header class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
      <div>
        <h2 class="text-lg font-semibold text-ink dark:text-white">Recent sessions</h2>
        <p class="text-xs uppercase tracking-wide text-graphite/60 dark:text-fog/60">Last 5 entries</p>
      </div>
      <a href="/tracking/sessions" class="text-sm font-semibold text-teal hover:text-teal-dark dark:text-orange dark:hover:text-orange-dark">Open tracker</a>
    </header>
    {{#if recentSessions.length}}
      <ul class="mt-4 space-y-3 text-sm text-graphite/80 dark:text-fog/80">
        {{#each recentSessions}}
          <li class="flex items-center justify-between rounded-lg border border-graphite/10 bg-fog/60 px-3 py-2 dark:border-fog/20 dark:bg-graphite/60">
            <div class="flex flex-col">
              <span class="font-semibold text-ink dark:text-white">{{#if plan_name}}{{plan_name}}{{else}}Session {{id}}{{/if}}</span>
              <span class="text-xs uppercase tracking-wide text-graphite/60 dark:text-fog/60">{{formatDate started_at}}</span>
            </div>
            <span class="text-xs font-semibold uppercase tracking-wide {{#if (eq status 'completed')}}text-teal dark:text-orange{{else if (eq status 'in-progress')}}text-graphite/70 dark:text-fog/70{{else}}text-graphite/50 dark:text-fog/50{{/if}}">{{capitalize status}}</span>
          </li>
        {{/each}}
      </ul>
    {{else}}
      <p class="mt-4 rounded-lg border border-graphite/10 bg-fog/60 px-3 py-2 text-sm text-graphite/70 dark:border-fog/20 dark:bg-graphite/60 dark:text-fog/70">No sessions logged this week yet. Start a workout from the tracker to see history here.</p>
    {{/if}}
  </section>

</main>
